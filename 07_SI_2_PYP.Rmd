---
title: "Supplementary File 2: Frontier plots for each country showing person-years of ITN access vs total nets required"
author: "Hannah Koenker"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: yes
    toc_depth: 2
    toc_float: yes
    fig_width: 7
    fig_height: 6
    fig_caption: yes
    df_print: kable
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE)
library(haven)
library(tidyverse)
library(geofacet)
library(broom)
library(readxl)
library(janitor)
library(countrycode)
library(data.table)
library(stringr)
library(stringi)
library(ggrepel)

# ![](images/TH_logo.jpg){width=1.0"}

######################
# Set figure theme and colors
######################

theme_set(theme_classic())

```


```{r grid}
geofacet_fname <- "data/geofacet_ssa.csv"
ssa_grid <- fread(geofacet_fname) %>% 
  arrange(code)
```

```{r retentiontimes}
ls <- read_excel("data/Copy of MAP ITN retention data.xlsx", sheet="Sheet1") %>%
  clean_names() %>%
  drop_na(country) %>%
  rename(lifespan=median_retention_years) %>%
  separate(x95_percent_ci, into = c("lb", "ub"),
           sep = "\\s*(–|-)\\s*", convert = TRUE)


levels <- ls$country[ls$type=='MAP'][rev(order(ls$lifespan[ls$type=='MAP']))]
ls$country_ord <- factor(ls$country, levels = levels)

# save a small version of retention times for joining into results tables:
rettimes <- ls %>% 
  filter(type=="MAP") %>% 
  mutate(name=case_when(country=="Burkina" ~ "Burkina Faso",
                        # country=="Cote d'Ivoire" ~ "Côte d'Ivoire",
                        country=="Congo (Republic of)" ~ "Rep. Congo",
                        TRUE~as.character(country))) %>% 
  dplyr::select(-type, -country, -lb, -ub, -site, -both, -country_ord) %>% 
  mutate(name=stri_trans_general(name,"Latin-ASCII")) %>% # remove o-hat from Cote d'Ivoire
mutate(iso_a2 = countrycode(name, origin = "country.name", destination = "iso2c"))

a3levels <- ssa_grid$code # make a list of the isoa2 countries included in retention times for later
```

```{r readpyp}
pyp <- read_dta("output/totalnetspyp.dta") %>% 
  clean_names() %>% 
  mutate(bestlabel=case_when(group==4 ~ paste0("pop/",round((scenario-400)/10, digits=1), " \nevery 3 years"),
                             group==5 ~ paste0("pop/",round((scenario-500)/10, digits=1), " \nevery 2 years"),
                             group==6 ~ "pop/1.8 \nevery 2 years",
                             group==1 ~ paste0("RCH at \npop x ",(scenario-100),"%"),
                             group==2 ~ paste0("annual CD \nat pop x ",(scenario-200),"%"),
                             group==3 ~ paste0("CD between campaigns \nat pop x ",(scenario-300),"%"),
                             TRUE ~ "")) %>% 
  mutate(bestlabel=case_when(bestlabel=="pop/1 every 2 years" ~ "pop/1.0 \nevery 2 years",
                             bestlabel=="pop/2 every 2 years" ~ "pop/2.0 \nevery 2 years",
                             bestlabel=="pop/1 every 3 years" ~ "pop/1.0 \nevery 3 years",
                             bestlabel=="pop/2 every 3 years" ~ "pop/2.0 \nevery 3 years",
                             TRUE ~ as.character(bestlabel)),
         wrap_lbl = stringr::str_wrap(bestlabel, width = 25),
         iso_a2=countrycode(iso3, origin = "iso3c", destination="iso2c")) %>% 
  left_join(rettimes)
```


```{r frontierplot_function}
# function that plots person-years of ITN access against total nets delivered for each country; showing only the points within each distribution strategy that provide the maximum PYP, for readability

pypfunctionloop <- function(iso3) {
 # ptitle <- paste0("p",{{iso3}})
lifespan <- pyp %>% 
   filter(iso3 == {{iso3}}) %>% 
  summarize(lf=mean(lifespan)) %>% 
  pull()
  
            
pypplot <- pyp %>%
  filter(iso3 == {{iso3}}, best==1) %>%
  ggplot(aes(
    x = pyp / 1000000,
    y = totalnets / 1000000,
    color = as.factor(group),
    # alpha = as.factor(best)
  )) +
  geom_point() +
  # theme(legend.position = c(1.25, 0.8),
    # theme(legend.position = c(.3, .8)) +
        # plot.margin = unit(c(0.1, 5, 0.1, 0.1), "cm")) +
  geom_text_repel(aes(label = ifelse(best == 1, bestlabel, "")), max.overlaps=10, hjust=0, size=2.5) + #  force=3, xlim = c(0, 300)
    # geom_text(aes(label = ifelse(best == 1, bestlabel, "")), size=2.5, fontface="bold", hjust=-.1, vjust=-.2) +
  scale_color_brewer(
    palette = "Dark2",
    labels = c(
      "Status Quo",
      "Full scale CD",
      "Campaigns + CD",
      "3-year campaigns",
      "2-year campaigns",
      "2-year campaigns (pop/1.8)"
    )
  ) +
  labs(x = "Person-years of ITN access (millions)",
       y = "Total nets delivered (millions)",
       color = "Scenario",
       title = paste0({{iso3}},": ",lifespan," years median retention time")) +
  scale_alpha_manual(values = c(.3, 1)) +
    # scale_x_continuous(limits=c(100,250)) +
  # coord_cartesian(clip = 'off') +
    theme(legend.position = "bottom") +
  guides(alpha = "none",
         color = guide_legend(override.aes = aes(label = ""))) ## remove the "a" from the marker in legend

print(pypplot)
  plotname <- paste("figs/pyp_",iso3,".pdf", sep = "")
  ggsave(plotname)
  
}

```

# Frontier Plots (alpha order by country code)

Note: all countries use an illustrative population of 10,000,000 people.

```{r pyploop, warning = FALSE, message=FALSE}
for(i in a3levels) {
   pypfunctionloop(i)
}
```
