---
title: How many nets are needed to reach universal coverage - an update
author:
  - name: Hannah Koenker
    email: hannah@trophealth.com
    affiliation: Tropical Health LLP
    correspondingauthor: true
    # footnote: 1
  - name: Marcy Erskine
    email: marcy.erskine@ifrc.org
    affiliation: International Federation of the Red Cross and Red Crescent Societies
  - name: Robert Opoku
    email: robert.opoku@ifrc.org
    affiliation: International Federation of the Red Cross and Red Crescent Societies
  - name: Eleanore Sternberg
    email: eleanore@trophealth.com
    affiliation: Tropical Health LLP
address:
  - code: Tropical Health LLP
    address: Baltimore, USA
# footnote:
#   - code: 1
#     text: ""
abstract: |
   [350 words max]
keywords: 
  - insecticide-treated nets
  - long-lasting insecticidal nets
journal: "Malaria Journal"
date: "`r Sys.Date()`"
classoption: review, 3p
bibliography: quantbibfile.bib
biblio-style: model6-num-names
# natbiboptions: longnamesfirst,angle,semicolon
linenumbers: false
numbersections: false
preprint: false
csl: https://www.zotero.org/styles/biomed-central
header-includes:
  - \usepackage{floatrow}
  - \floatsetup[figure]{capposition=top}
  - \floatplacement{figure}{H}
  - \usepackage{setspace}\doublespacing
  - \biboptions{sort&compress}
output: 
  rticles::elsevier_article:
    latex_engine: xelatex
    keep_tex: true
    citation_package: natbib
editor_options: 
  chunk_output_type: console
---

```{r setup, echo=FALSE, include=FALSE}
######################
# Load Libraries
######################
# Load reading and basic libraries
library(rticles)
library(tidyverse)
library(haven)
library(readxl)
library(janitor)
library(viridis)
library(broom)
library(english)
library(magrittr)
library(lubridate)
library(countrycode)
library(data.table)

# Load map related libraries
library(sf)
library(tmap)
library(maptools)
library(maps)
library(spData)
library(distill)
library(geofacet)

# Load tables and plot libraries
library(flextable)
library(gtsummary)
library(gt)
library(jtools)
library(kableExtra)
library(float)
library(ggstance)
library(knitr)
library(stringr)
library(ggpubr) # includes ggarrange and cowplot 

# Load QR libraries
library(quantreg)
library(splines)

##### Might need to reinstall pandoc, if so, run this from Terminal. Takes a few minutes:
# brew install pandoc
# brew install pandoc-citeproc
# brew install pandoc-crossref
######

######################
# Set figure theme and colors
######################

theme_set(theme_classic())
# scale_colour_continuous <- function(...) scale_color_brewer(palette = "RdBu") 
# scale_colour_discrete   <- function(...) scale_color_brewer(palette = "Set2") # 
# scale_colour_binned     <- function(...) scale_color_fermenter(palette = "Set3")
# scale_fill_continuous <- function(...) scale_fill_brewer(palette = "RdBu") #
# scale_fill_discrete   <- function(...) scale_fill_brewer(palette = "Set3") # 
# scale_fill_binned     <- function(...) scale_fill_fermenter(palette = "Set3")

######################
# Knitr options
######################

knitr::opts_chunk$set(
  echo = FALSE, message=FALSE, warning=FALSE) ## , dev="cairo_pdf")

# setwd("data")
# knitr::opts_chunk$set(fig.pos = "!H", out.extra = "")
# knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE, dev="cairo_pdf", fig.width=7, fig.height=3.5)

# reason_palette <- c("net used"=rgb(102,194,165, maxColorValue=255), "objective" = rgb(141,160,203, maxColorValue=255), "subjective" = rgb(252,141,98, maxColorValue=255),  "risk perception" = rgb(231,138,195, maxColorValue=255),  "net attributes" = rgb(229,196,148, maxColorValue=255), "extra" = rgb(166,216,84, maxColorValue=255), "fears" = rgb(255,217,47, maxColorValue=255), "other"="lightgray")

```

# Background

Insecticide treated nets (ITNs) have served as the cornerstone of malaria vector control in sub-Saharan Africa for the past two decades. Over 2.5 billion ITNs have been delivered to countries [@Milliner:2016um], primarily through periodic mass distribution campaigns scheduled at approximately three-year intervals, aligning with the expected lifespan of nets. Recent work has shown significant variation in ITN durability across geographic zones, and while some studies support a three-year median lifespan, multi-country analyses of ITN retention times indicate half of countries can expect two years or less of useful life for the majority of nets they distribute [@10.1038/s41467-021-23707-7]. The implications of shorter-than-expected retention times have important implications for the way countries quantify ITN commodity need for mass campaigns, and raise several key questions. First, what is the projected impact of the mismatch in campaign cycle and ITN retention in terms of overall ITN coverage? Second, if mass campaigns every three years are insufficient due to ITNs lasting only 1-2 years, is switching to a two-year campaign cycle indicated, or are there alternative or supplemental ways to distribute ITNs to ensure high rates of ITN access are maintained over time? Third, with what we know now about ITN retention and ITN distribution modalities, is population divided by 1.8 (as currently recommended [@WorldHealthOrganization:2019ws]) the correct quantification approach for mass campaigns for all countries? Finally, what would optimum ITN quantification look like for countries given their particular ITN retention times, aiming to sustain high levels of ITN access (the necessary, but not sufficient, precursor to ITN use)?

This paper explores these questions using an existing stock and flow model [@10.1186/s12936-022-04272-w] to project population ITN access for countries in sub-Saharan Africa over five different distribution scenarios, using estimated ITN retention times from Bertozzi-Villa et al [@10.1038/s41467-021-23707-7] and varying quantification approaches within each distribution scenario. 

# Methods

## Projections of future coverage

Each country was assigned an indicative population of 10 million people in the database, starting in 2020, and an annual population growth rate of 3%, as the model outputs are adjusted for population and thus do not require specific population estimates.

ITNs were distributed in the model for each scenario as shown in Table 1.

Table: Distribution Scenarios and their ITN inputs

| Scenario                       | Mass Campaign                                                                 | ANC/EPI (routine)                              | Annual school/ community                                              |
|--------------------------------|-------------------------------------------------------------------------------|------------------------------------------------|-----------------------------------------------------------------------|
| 1.     “Status Quo”            | In 2022, 2025, 2028, 2031, 2034 at population / 1.8                           | 2020-2035, varying from 5-7% of the population | none                                                                  |
| 2.     “Full-scale continuous” | In 2020, to establish high coverage at population / 1.8                       | 2021-2035 at 6% of the population              | 2022-2032 varying from 1-20% of the population                        |
| 3.     “Mass plus continuous”  | In 2022, 2025, 2028, 2031, 2034 at population / 1.8                           | 2020-2035 at 6% of the population              | Only in years between campaigns, varying from 1-20% of the population |
| 4.     “Varying 3-year mass”   | In 2022, 2025, 2028, 2031, 2034, varying from population / 1.0-2.0            | 2020-2035 at 6% of the population              | none                                                                  |
| 5.     “Varying 2-year mass”   | In 2022, 2024, 2026, 2028, 2030, 2032, 2034 varying from population / 1.0-2.0 | 2020-2035 at 6% of the population              | none                                                                  |

For each year, the stock and flow model used a country-specific estimated median lifespan from Bertozzi-Villa et al [@10.1038/s41467-021-23707-7] to decay each crop of distributed nets annually. The net decay functions rely on smooth-compact loss function developed by Nakul Chitnis and described in Koenker et al and Bhatt et al [@Koenker:2013ed; @Bhatt:2015gn; @10.1186/s12936-022-04272-w], and are shown in Fig. \ref{ret_decay_fig}.

```{r dmmap}
ls <- read_excel("../data/Copy of MAP ITN retention data.xlsx", sheet="Sheet1") %>%
  clean_names() %>%
  drop_na(country) %>%
  rename(lifespan=median_retention_years) %>%
  separate(x95_percent_ci, into = c("lb", "ub"),
           sep = "\\s*(–|-)\\s*", convert = TRUE)


levels <- ls$country[ls$type=='MAP'][rev(order(ls$lifespan[ls$type=='MAP']))]
ls$country_ord <- factor(ls$country, levels = levels)


dmmap <- ls %>%
  ggplot() +
  geom_point(aes(
    y = lifespan,
    x = country_ord,
    color = type,
    alpha = both,
    shape = type
  )) +
  geom_linerange(aes(
    x = country_ord,
    ymin = lb,
    ymax = ub,
    color = type,
    alpha = both
  )) +
  theme_classic() +
  scale_alpha_continuous(range = c(0.25, 1), guide = "none") +
  scale_color_hue(name = "Study Type", labels = c("DM", "MAP")) +
  scale_shape_manual(
    name = "Study Type",
    labels = c("DM", "MAP"),
    values = c(19, 17)
  ) + # if guide=="none" here, shape won't appear correctly in legend
  theme(legend.position="right",
        text = element_text(size = 9),
        axis.text.x = element_text(
    angle = 45,
    vjust = 0.9,
    hjust = 1,
    size = 7
  )) +
  labs(x = "",
       y = "Retention / median lifespan",
       size=4)

# dmmap
# ggsave("MAP_vs_DM_lifespans.png")

```

```{r dmcurves}
### Graphing Stata Decay Curves in GGPLOT ####

# tz <- read_dta("/Users/hannahkoenker/Dropbox/A DHS MIS Datasets/Analysis/Decay Curves/tz_decay_only.dta")
curves <- read_dta("/Users/hannahkoenker/Dropbox/A DHS MIS Datasets/Analysis/Decay Curves/curves_only.dta") %>% 
  filter(lifespan<5.5)

decay <- ggplot() +
  geom_line(
    data = curves,
    aes(
      x = tdist,
      y = percsurv,
      color = as.factor(lifespan),
      linetype = as.factor(lifespan)
    ),
    alpha = 0.4
  ) +
  # geom_ribbon(
  #   data = tz,
  #   aes(x = tdist, ymin = lower, ymax = upper, fill="95% CI"),
  #   # fill = "lightgrey",
  #   alpha = 0.7
  # ) +
  # geom_line(data = tz, aes(x = tdist, y = percsurv), color = "orange") +
  theme_minimal() +
  theme(
    panel.grid.minor = element_blank()
  ) +
  # scale_fill_manual(name="Tanzania \n estimate", values="lightgrey") +
  scale_color_manual(
    name = "Median \nLifespan \n(years)",
    values = c(
      "dodgerblue",
      "dodgerblue",
      "red",
      "red",
      "seagreen",
      "seagreen",
      "darkorchid",
      "darkorchid",
      "pink"
    )
  ) +
  scale_linetype_manual(name = "Median \nLifespan \n(years)", values = c(1, 2, 1, 2, 1, 2, 1, 2, 1)) +
  scale_x_continuous(breaks=seq(0,9,1)) +
  theme(legend.position="right",
        text = element_text(size = 9)) +
  labs(
    y = "Percent of nets surviving",
    x = "Years since distribution",
    # title = "Net decay curves for \n varying median lifespans",
    color = "",
    fill=""
  )

# decay

# ggsave("decay_npc.png", width=8, height=5, units="in")

```

```{r npcaccess}
Ddta <- read_dta("/Users/hannahkoenker/Dropbox/R Directory/TZ_access/01_ITN_Access_from_NPC/regional_ITN_indicators_access.dta")
D <- with(Ddta, data.frame(y = access_merg, x = itnpers, z = meanhh))

A <- as.matrix(D)
B <- as.data.frame(A)

# First plot the dots:

pdf(
  "Access_NPC.pdf",
  height = 6,
  width = 6,
  )
with(B,
     plot(
       x,
       y,
       cex = .5,
       col = "grey",
       ylim = c(0, 105),
       xlab = "ITNs per capita",
       ylab = "Population ITN Access (percent)")
     )
# title(main = "Title")

taus <- 1:3/4

xx <- 1:99/100
colors <- c(2,1,2)

G <- matrix(0,99,length(taus))
for(i in 1:length(taus)){
    f <- rqss(y ~ qss(x, constraint = "I", lambda = .5), tau = taus[i], data = B)
    G[,i] <- predict(f, newdata = list(x = xx))
    lines(xx,G[,i], col = colors[i], lwd = 2)
}
dev.off()

### Make G into a dataframe and rename the variables for ggplot later: 
gg <- as.data.frame(G) %>% 
  mutate(access=V2,
         lb=V1,
         ub=V3) %>% 
  arrange(access) %>% 
  mutate(npc=1:n()/100) # make a new variable which is the row count and also NPC because Dad did not include this!

npc <- ggplot() +
  geom_point(data=B, aes(x,y), alpha=0.1, shape=1, size=0.5) +
  geom_line(data=gg, aes(npc, access)) +
  geom_line(data=gg, aes(npc, lb, color="50% confidence bounds")) +
  geom_line(data=gg, aes(npc, ub, color="50% confidence bounds")) +
  theme_minimal() +
  theme(legend.position="bottom",
        text = element_text(size = 9)) +
  labs(x="ITNs per capita (NPC)",
       y="% ITN Access",
       color="")
       # title="ITN Access as a function \n of nets per capita")


```

```{r ret_decay_fig, fig.width = 7, fig.height = 6, fig.align='center', fig.topcaption=TRUE, out.width="80%", fig.cap = "\\label{ret_decay_fig}A) ITN retention times and median lifespans estimated from durability monitoring studies B) Smooth-compact loss function for net decay C) nonparametric conditional quartile function for ITN access as a function of NPC"}

ggarrange(dmmap,
          ggarrange(decay, npc, ncol=2, labels=c("B","C")),
          nrow=2,
          labels="A")
```

```{r}
## Produces almost exactly identical graph combination:

# ggdraw() +
#   draw_plot(dmmap, x = 0, y = .5, width = 1, height = .5) +
#   draw_plot(decay, x = 0, y = 0, width = .5, height = .5) +
#   draw_plot(npc, x = .5, y = 0, width = .5, height = 0.5) +
#   draw_plot_label(label = c("A", "B", "C"), size = 15,
#                   x = c(0, 0, .5), y = c(1, .5, 0.5))
```

The total net crop (consisting of all surviving nets from various channels to date) was summed for each year and country. This was then divided by the population projected to calculate nets-per-capita (NPC) in each year and council.

To estimate ITN access from NPC, a nonparametric conditional quartile function for ITN access as a function of NPC was estimated from 124 demographic health survey data and malaria indicator surveys (MIS). A grid of 100 points was produced and used to predict ITN access from NPC (Fig. \ref{ret_decay_fig}). Confidence intervals for both estimated median lifespan and the function of ITN access vs NPC were used to generate an overall confidence interval around the estimate of ITN access.

To further understand the relative sizes of ITN distributions through various channels, total ITNs delivered per channel were divided by the population and expressed as “nets issued as a percentage of the population” (NPP). 

## Scenarios

To inform recommendations for quantification of ITNs, the above process was used to model ITN distributions under five typical ITN distribution scenarios, varying quantification approaches within each scenario. The majority of malaria-endemic countries currently implement Scenario 1; Tanzania is an example of Scenario 2, while Ghana exemplifies Scenario 3. While countries aim to deliver mass campaigns every three years, some have recently argued for campaign every two years to offset shorter median net lifespans.

1.	“Status Quo”: Mass campaigns every three years with routine distribution of ITNs to pregnant women and infants through antenatal clinics (ANC) and immunization visits (EPI). Quantification of the mass campaigns was fixed at population / 1.8 while quantification of routine distribution varied from population x 5%-7%.
2.	“Full-scale continuous”: Full-scale annual school distribution of ITNs with routine distribution of ANC and EPI ITNs, fixing the routine distribution at population x 6% and varying the quantification of school distributions from population x 1-20%
3.	“Mass plus continuous”: Mass campaign every three years with routine distribution of ANC and EPI ITNs and with annual school distribution in a limited number of classes, or limited community distribution in the years between campaigns. Quantification of the mass campaigns was fixed at population / 1.8 and routine distribution at population x 6%, varying the annual school/community distribution between population x 7-25%.
4.	“Varying 3-year mass”: Mass campaigns every three years with routine distribution of ITNs to pregnant women and infants through antenatal clinics (ANC) and immunization visits (EPI). Quantification of routine distribution was fixed at 6%, and quantification of the mass campaigns was varied from population / 1.0 to population / 2.0 in increments of 0.1.
5.	“Varying 2-year mass”: Mass campaigns every two years with routine distribution of ITNs to pregnant women and infants through antenatal clinics (ANC) and immunization visits (EPI). Quantification of routine distribution was fixed at 6%, and quantification of the mass campaigns was varied from population / 1.0 to population / 2.0 in increments of 0.1.

All scenarios with mass campaigns began with a mass campaign in 2022 and ended in 2035. The “full scale continuous” scenario assumed a mass campaign (quantified with population / 1.8) in 2020 to scale up coverage prior to switching over to a fully continuous ITN strategy. 

To assess feasibility of large-scale school distribution in relation to optimal quantification factors, the proportion of the population that are primary school students currently attending school was calculated from the most recent Demographic and Health Surveys for each country, obtained with permission from dhsprogram.com. 

# Results

Given a target of 80% ITN access, the recommended quantification approaches for each scenario varied considerably across countries, driven primarily by the median retention time. Recommended quantification approaches are summarized for the scenarios that include continuous distribution in Table 2, for 3-year mass campaigns in Table 3, and for 2-year mass campaigns in Table 4.

For Scenario 2, which relies on full-scale annual continuous distribution in combination with routine ANC/EPI ITN delivery to maintain access, the annual quantifier needed to maintain ITN access at 70% ranged from 7% of the population in Cameroon and The Gambia, to 26% of the population in Benin, Djibouti, Liberia, Mauritania, South Sudan, and Chad. Similarly, to maintain ITN access at 80%, the quantifier ranged from 10% for Cameroon and Gabon, to 30% for Angola. In only a few countries was ITN access able to reach 90% - from 17% of the population in Cameroon, to 30% in Angola, Cote d’Ivoire, Madagascar, and Uganda. 

For Scenario 3, where mass campaigns are conducted every three years, routine ITNs through ANC/EPI are conducted consistently, and continuous distribution supplements ITN access in the years between campaigns, there was also a range of quantifiers for the annual continuous distribution channels. At the 70% target, many countries required ITNs equivalent to 7% of the population, but this rose to 25% for Liberia, South Sudan, and Chad. At the 80% target, some countries still achieved this with 7% of the population in ITNs between campaigns, while Benin and Mauritania are estimated to need 30% of the population in ITNs. Several countries were able to maintain ITN access at 90% with only limited inputs from the continuous channel, at 7% of the population, including Cameroon, Mali, Niger, and Zimbabwe.

```{r table_min_quantifier, table.width = 7, table.height = 6, table.align='center', table.topcaption=TRUE, out.width="80%", table.cap = "\\label{table_min_quantifier}Recommended annual quantifiers for scenarios involving continuous distribution. For example, Angola would need to distribution ITNs equivalent to 25% of the population on an annual basis in order maintain ITN access at a 70% target. To maintain ITN access at an 80% target, ITN quantification for continuous distribution would need to be population x 30% on an annual basis. Given Angola’s estimated net decay rate, it is not feasible to maintain ITN access at 90%, assuming quantification rates for annual continuous distribution are capped at 30% of the population"}

table_q_s2s3 <- read_csv("../output/s2s3table.csv")
Table_Quant_S2_S3 <- table_q_s2s3 %>% 
  gt() %>% 
  tab_options(.,     container.width = 500, container.height =     500) %>% 
  cols_label(iso_a2 = "Country Code",
             s270 = "70%",
             s280 = "80%",
             s290 = "90%",
             s370 = "70%",
             s380 = "80%",
             s390 = "90%",
  ) %>% 
   fmt_missing(
    columns = everything(),
    missing_text = ""
  ) %>%
   tab_spanner(columns = 2:7, label = "Targeted ITN access") %>%
  tab_spanner(columns = 2:4, label = "Scenario 2 (full continuous strategy)") %>% 
  tab_spanner(columns = 5:7, label = "Scenario 3 (continuous between mass campaigns)") %>% 
  tab_header(
    title = "Minimum quantifier to sustain ITN access at target level"
  ) 
Table_Quant_S2_S3

```

For Scenario 4, the quantifier used for 3-year mass campaigns (in combination with routine ITN distribution at ANC/EPI clinics) was varied from 1.0 to 2.0. The lowest level of ITN access between campaigns is shown in Table 3. Under the current recommended quantifier of 1.8, only Cameroon, Eritrea, Gabon, and Niger were estimated to maintain ITN access at or above 80% between campaigns. 

```{r table_ucc_quantifier, fig.width = 7, fig.height = 6, fig.align='center', fig.topcaption=TRUE, out.width="80%", fig.cap = "\\label{table_ucc_quantifier}Lowest level of ITN access between 3-year campaigns at different population quantifiers. For example, with the standard quantifier of population / 1.8, Burkina Faso reaches a low point of 45% ITN access between campaigns. Using population / 1.1 would result in an estimated low point of 61% population ITN access between campaigns. Routine ITN delivery to pregnant women and infants is assumed."}



```

Table 4 provides a similar picture but for campaigns conducted every 2 years. Under a population / 1.8 quantifier, CAR, Congo, Cote d’Ivoire, Cameroon, Eritrea, Gabon, Ghana, the Gambia, Kenya, Madagascar, Mali, Niger, Nigeria, Sudan, Togo, Tanzania, Uganda, and Zimbabwe would all maintain ITN access at or above 80% between campaigns. In other countries, 2-yearly campaigns closer to one ITN per person in order to maintain ITN access at the 80% target.

```{r table_2ucc_quantifier, fig.width = 7, fig.height = 6, fig.align='center', fig.topcaption=TRUE, out.width="80%", fig.cap = "\\label{table_2ucc_quantifier}Lowest level of ITN access between 2-year campaigns at different population quantifiers. For example, with the standard quantifier of population / 1.8, Burkina Faso reaches a low point of 79% ITN access in the year between campaigns. Using population / 1.2 would result in an estimated low point of 91% population ITN access between campaigns. Values of 100 indicate excess nets in the system (for example Cameroon). Routine ITN delivery to pregnant women and infants is assumed."}



```

Figures 2-4 illustrate scenario results for each country, for scenarios 1 (Figure 2), scenario 2 (Figure 3), and scenario 3 (Figure 4). Inputs of ITNs are indicated in orange for each year; the resulting population ITN access estimate is shown in green. The typical rise and fall of ITN access is apparent in Figures 2 and 4, while ITN access is maintained at a steady rate in Figure 3 where distributions are annual through continuous channels.

```{r grid}
geofacet_fname <- "../data/geofacet_ssa.csv" # load geofaceting data for sub saharan africa
ssa_grid <- fread(geofacet_fname) # make it a grid for tiny maps in africa continent layout

s1title <- "3-year mass campaigns with ANC/EPI at "
s2title <- "ANC/EPI at 6% and annual school/community distribution at "
s3title <- "3-year mass campaigns with ANC/EPI at 6% and between-campaign school/community distribution at "
s4title <- "3-year mass campaigns with ANC/EPI, at population / "
s5title <- "2-year mass campaigns with ANC/EPI, at population / "
```

```{r plot_function}
# read data in and plot
geofun <- function(scen, title) {
  splot <- read_dta(filename) %>%
    select(percpop, year, accrk, iso3, acclb_npclb, accub_npcub) %>%
    mutate(name = countrycode(iso3, origin = "iso3c", destination = "country.name")) %>%
    mutate(code = iso3) %>%
    ggplot(aes(x = year - 2000)) +
   geom_hline(yintercept = 80, size=0.25, linetype="solid", color = "red", alpha = 0.5) +
  geom_hline(yintercept = 90, size=0.25, linetype="solid", color = "red", alpha = 0.5) +
  # geom_line(aes(y = percpop, color = "percpop"), alpha = 0.5, size = 0.75) +
  geom_line(aes(y = accrk, color = "accrk"), alpha = 0.5, size = 0.75) +
    geom_ribbon(aes(ymin = acclb_npclb, ymax = accub_npcub),
                color = NA,
                alpha = 0.25) +
    scale_color_brewer(
      palette = "Set2",
      labels = c("Predicted \nITN Access")
    ) +
    scale_x_continuous(breaks = seq(20, 35, 5),
                       labels = c("'20", "'25", "'30", "'35")) +
    theme_minimal() +
    facet_geo( ~ code, grid = ssa_grid, label = "code") +
    labs(title = paste(title, X, "% of the population"),
         x = "",
         y = "Percent",
         color = "") +
    theme(
      # legend.position="none",
      # axis.text.x = element_text(angle=45, hjust=1)
      # axis.text.x = element_blank(),
      axis.line = element_blank(),
      axis.ticks.x = element_blank(),
      axis.text = element_text(size = 6),
      panel.grid.major.x = element_line(color = "darkgrey", size =
                                          0.25)
    ) +
    scale_alpha(guide = 'none') +
    scale_size(guide = 'none')
  print(splot)
  # plotname <- paste("figs/scen_",scen,".pdf", sep = "")
  # ggsave(plotname)
}
```

```{r geo_facets_3ucc, fig.width = 7, fig.height = 6, fig.align='center', fig.topcaption=TRUE, out.width="80%", fig.cap = "\\label{geo_facets_3ucc}ITN access estimated for 3-year mass campaign strategy, with ANC/EPI distribution at 6% of the population annually"}
s1 <- 106 ## set the scenario selected for inclusion in the paper

 # create the path and filename from the scenario number
  filename = paste("../output/runs/", s1, ".dta", sep = "")
  
  # extract the quantifier from scenario number (last two digits) to put into the titles
  X <- s1-round(s1,digits=-2)
  
  geofun(scen = s1, title = s1title)
```


```{r geo_facets_cd, fig.width = 7, fig.height = 6, fig.align='center', fig.topcaption=TRUE, out.width="80%", fig.cap = "\\label{geo_facets_cd}Estimated ITN access with annual ANC/EPI at 6% and full continuous distribution strategy at 17% of the population in nets each year. Shaded areas indicate 95% confidence intervals accounting for both net retention times and ITN access as a function of nets-per-capita (NPC)"}
s2 <- 217 ## set the scenario selected for inclusion in the paper

 # create the path and filename from the scenario number
  filename = paste("../output/runs/", s2, ".dta", sep = "")
  
  # extract the quantifier from scenario number (last two digits) to put into the titles
  X <- s2-round(s2,digits=-2)
  
  geofun(scen = s2, title = s2title)
```


```{r geo_facets_cducc, fig.width = 7, fig.height = 6, fig.align='center', fig.topcaption=TRUE, out.width="80%", fig.cap = "\\label{geo_facets_cducc}Scenario 3 - three-year mass campaigns with ANC/EPI distribution at 6%, and between-campaign continuous distribution at 10%"}
s3 <- 310 ## set the scenario selected for inclusion in the paper

 # create the path and filename from the scenario number
  filename = paste("../output/runs/", s3, ".dta", sep = "")
  
  # extract the quantifier from scenario number (last two digits) to put into the titles
  X <- s3-round(s3,digits=-2)
  
  geofun(scen = s3, title = s3title)
```


The complete set of graphs for all scenarios is included as Supplemental File 1.

Table 5 summarizes the recommended quantifiers under each scenario, given a target of maintaining 80% population ITN access. 

```{r table_reccs, fig.width = 7, fig.height = 6, fig.align='center', fig.topcaption=TRUE, out.width="80%", fig.cap = "\\label{table_reccs}Summary of recommended quantifiers for scenarios, to maintain ITN access at or above 80%"}
# now need to compare the % current primary students to the percent quantifier needed to maintain 80% ITN access.
schv2 <- read_xlsx("/Users/hannahkoenker/Dropbox/A DHS MIS Datasets/Analysis/School Quant/schoolquant_v2.xlsx") %>% 
  clean_names() %>% 
   # mutate(name = countrycode(iso3, origin = "iso3c", destination = "country.name")) %>%
  mutate(name_long = case_when(country == "DRC" ~ "Democratic Republic of the Congo",
                          country == "Congo" ~ "Republic of the Congo",
                          country == "Cote" ~ "Côte d'Ivoire",
                          country == "Sierra" ~ "Sierra Leone",
                          country == "Sao" ~ "Sao Tome",
                          country == "Gambia" ~ "The Gambia",
                          country == "Swaziland" ~ "eSwatini",
                          country == "Burkina" ~ "Burkina Faso",
                          TRUE ~ as.character(country))) %>% 
  rename(feasible17 = full_scale_school_is_feasible,
         for17 = number_of_classes_needed_annually_for_full_scale_school_distribution_pop_5_8_or_17_percent_of_pop,
         percattending = percent_hh_with_child_attending_primary_school,
         currentprim = percent_population_that_are_current_primary_students,
         classes = number_classes_needed_for_between_campaign_school_distribution
  )
  
qt <- read.csv("../output/s2s3table.csv")

africa = world %>%
  filter(continent == "Africa",!is.na(iso_a2)) 

sch <-  africa %>%
    left_join(schv2, by = "name_long") %>%
    st_transform("+proj=aea +lat_1=20 +lat_2=-23 +lat_0=0 +lon_0=25")

# then join with school dataset on iso_a2
sch <- sch %>% 
  left_join(qt, by = "iso_a2") %>% 
  mutate(feasible80 = if_else(currentprim > s280,"yes","no"),
         feasible70 = if_else(currentprim > s270, "yes","no"))

sumtable <- read_xlsx("../data/summary_target80.xlsx") %>% 
  clean_names() %>% 
  left_join(qt, by = "iso_a2") %>% 
  mutate(name = countrycode(iso_a2, origin = "iso2c", destination = "country.name"))

table80 <- sumtable %>% 
  select(name, scenario_1, scenario_4, scenario_5,s280, s380) %>% 
  rename(scenario_2 = s280,
         scenario_3 = s380) %>% 
  select(name, scenario_1, scenario_2, scenario_3, scenario_4, scenario_5)

gtable80 <- gt(table80) %>% 
  tab_header(
    title = "Recommended quantifiers",
    subtitle = "To maintain 80% population ITN access") %>% 
   tab_spanner(
    label = "Continuous Distribution",
    columns = c(scenario_2, scenario_3)
  ) %>%
  tab_spanner(
    label = "Mass Campaign",
    columns = c(scenario_4, scenario_5)
  ) %>% 
   cols_label(
    scenario_1 = html("Campaign + routine"),
    scenario_2 = html("Full-scale continuous + routine"),
    scenario_3 = html("Campaign + routine + continuous between campaigns"),
    scenario_4 = html("3-yearly campaigns"),
     scenario_5 = html("2-yearly campaigns")
  ) %>% 
  fmt_missing(
    columns = everything(),
    missing_text = ""
  )
gtable80
```


```{r kable_table80}
kable(table80, col.names = c("Country","Campaign + routine","Full-scale continuous + routine","Campaign + routine + continuous between campaigns","3-yearly campaigns","2-yearly campaigns"), caption="(Kable) Summary of recommended quantifiers for scenarios, to maintain ITN access at or above 80%") %>% kableExtra::kable_styling()
```

Adjustments in quantification for ANC-EPI distribution did not lead to large differences in ITN access in Scenario 1. The key factors driving variation across countries within a given scenario were the estimated retention times for each country. 

Using the most recent Demographic and Health Survey, the proportion of the population that were primary school students currently attending school was calculated and compared to the population quantifiers needed to achieve 70% and 80% ITN access targets in Scenario 2. Countries where the proportion of primary school students attending school met or exceeded the population quantifier are shown in Figure 5, as an indication of where annual school distribution would be feasible. This assumes that only one ITN is given per pupil; for the orange countries in Figure 5, giving more than 1 ITN per pupil could provide a solution.

```{r fig_school, fig.width = 7, fig.height = 6, fig.align='center', fig.topcaption=TRUE, out.width="80%", fig.cap = "\\label{fig_school}Feasibility of large-scale annual school distribution to achieve ITN access targets"}

```

# Discussion

-	Mass campaigns + ANC-EPI (7%) produces low access for most countries
-	Approach 80% access when Cameroon at 15%; TZA requires 22%; Liberia at 25% is still only 60%
-	X% of countries won’t reach 80% even at 25%....
-	Ghana needs X and is only doing Y
-	What is the lowest access we are willing to tolerate between campaigns, or at any time…?
-	2-year campaigns….?????
-	Link back to 4 questions from the Intro
-	No wonder no one is meeting 80% targets
-	If we want 80% ITN use we would need 90% access as the target
-	Based on projections across multiple countries using varying ITN retention times from Bertozzi-Villa, overall recommendations for CD and campaign quantification for other countries
-	Providing greater and greater numbers of nets/more frequently disincentivizes retention times (?)
-	Limitation of the methods 
    - Parameter assumptions - decay rates, some countries with limited data; rates expected to vary within the country;  (behaviors; nets)
    - Relationship between Nets-as-proportion-of-population and ITN access may be different under a Scenario 1 vs a Scenario 2, depending on the degree of oversaturation inherent in the distribution channel (schools; etc).

# Conclusion

Given variation in ITN retention times across countries, tailored quantification approaches for mass campaigns and continuous distribution strategies are warranted. To reach target levels of ITN use of 80% of the population, ITN access must be maintained near 90% in most settings. The quantity of ITNs required to meet these goals are substantially larger than current plans. National programmes and their funding partners should work to increase the number of ITNs distributed to those vulnerable to malaria, while at the same time working to extend the useful life of these critical commodities.

# Declarations

## Ethics approval and consent to participate

Not applicable

## Consent for publication

Not applicable

## Availability of data and materials

Code is available at https://github.com/hkoenker/

## Competing interests

The authors declare that they have no competing interests.

## Funding

HK was supported through a grant from The Bill & Melinda Gates Foundation.

## Authors' contributions

## Acknowledgements

## Authors' information (optional)

# Supplementary information

# References
